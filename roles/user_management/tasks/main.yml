- name: Generate password hash
  set_fact:
    hashed_password: "{{ NEW_USER_PASSWORD | password_hash('sha512') }}"

- name: Create group
  group:
    name: admin
    state: present

- name: Add user
  user:
    name: "{{ NEW_USER }}"
    state: present
    groups: [sudo, admin]
    append: true
    password: "{{ hashed_password }}"
    comment: ""
    shell: /bin/bash
    create_home: true
    skeleton: /etc/skel

- name: Create .ssh directory
  file:
    path: "/home/{{ NEW_USER }}/.ssh"
    state: directory
    group: admin
    mode: '0700'
    owner: "{{ NEW_USER }}"

- name: Add SSH key to authorized_keys
  authorized_key:
    user: "{{ NEW_USER }}"
    key: "{{ SSH_PUB_KEY }}"
    state: present
    manage_dir: true