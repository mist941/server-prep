- name: Generate password hash
  set_fact:
    hashed_password: "{{ NEW_USER_PASSWORD | password_hash('sha512') }}"

- name: Add user
  user:
    name: "{{ NEW_USER }}"
    state: present
    groups: sudo
    append: true
    password: "{{ hashed_password }}"
    comment: ""

- name: Configure sudo privileges for new user
  copy:
    dest: /etc/sudoers.d/{{ NEW_USER }}
    content: "{{ NEW_USER }} ALL=(ALL) ALL"
    mode: '0440'
    validate: /usr/sbin/visudo -cf %s

- name: Create .ssh directory
  file:
    path: "/home/{{ NEW_USER }}/.ssh"
    state: directory
    mode: '0700'
    owner: "{{ NEW_USER }}"
    group: "{{ NEW_USER }}"

- name: Add SSH key to authorized_keys
  authorized_key:
    user: "{{ NEW_USER }}"
    key: "{{ SSH_PUB_KEY }}"
    state: present