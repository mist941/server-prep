- name: Generate password hash
  ansible.builtin.set_fact:
    hashed_password: "{{ NEW_USER_PASSWORD | password_hash('sha512') }}"

- name: Create group
  ansible.builtin.group:
    name: admin
    state: present

- name: Add user
  ansible.builtin.user:
    name: "{{ NEW_USER }}"
    state: present
    groups: [sudo, admin]
    append: true
    password: "{{ hashed_password }}"
    comment: ""
    shell: /bin/bash
    create_home: true
    skeleton: /etc/skel
  when: NEW_USER is defined
  no_log: true

- name: Create .ssh directory
  ansible.builtin.file:
    path: "/home/{{ NEW_USER }}/.ssh"
    state: directory
    group: admin
    mode: '0700'
    owner: "{{ NEW_USER }}"

- name: Show SSH key
  ansible.builtin.debug:
    var: SSH_PUB_KEY

- name: Add SSH key to authorized_keys
  ansible.posix.authorized_key:
    user: "{{ NEW_USER }}"
    key: "{{ SSH_PUB_KEY }}"
    state: present